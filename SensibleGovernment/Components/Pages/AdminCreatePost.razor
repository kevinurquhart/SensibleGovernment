@page "/admin/createpost"
@using SensibleGovernment.Models
@using SensibleGovernment.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject PostService PostService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Create Post - The Sensible Citizen</PageTitle>

@if (isLoading)
{
    <div class="container py-5">
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
}
else if (!isAuthorized)
{
    <div class="container py-5">
        <div class="alert alert-danger">
            <h4>Access Denied</h4>
            <p>You must be an administrator to access this page.</p>
            <a href="/" class="btn btn-primary">Return to Home</a>
        </div>
    </div>
}
else
{
    <div class="container py-4">
        <h1 class="mb-4">
            <i class="bi bi-pencil-square"></i> Create New Article
        </h1>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i> @errorMessage
                <button type="button" class="btn-close" @onclick="@(() => errorMessage = null)"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> @successMessage
            </div>
        }

        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <ul class="nav nav-pills card-header-pills">
                    <li class="nav-item">
                        <button class="nav-link @(activeSection == "basic" ? "active" : "text-white")"
                                @onclick="@(() => activeSection = "basic")">
                            <i class="bi bi-info-circle"></i> Basic Info
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link @(activeSection == "content" ? "active" : "text-white")"
                                @onclick="@(() => activeSection = "content")">
                            <i class="bi bi-body-text"></i> Content
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link @(activeSection == "media" ? "active" : "text-white")"
                                @onclick="@(() => activeSection = "media")">
                            <i class="bi bi-image"></i> Media
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link @(activeSection == "sources" ? "active" : "text-white")"
                                @onclick="@(() => activeSection = "sources")">
                            <i class="bi bi-link-45deg"></i> Sources
                        </button>
                    </li>
                </ul>
            </div>

            <div class="card-body">
                <EditForm Model="@newPost" OnValidSubmit="HandleCreatePost">
                    <DataAnnotationsValidator />

                    @* Basic Info Section *@
                    <div class="@(activeSection == "basic" ? "" : "d-none")">
                        <div class="mb-3">
                            <label class="form-label">Article Title *</label>
                            <InputText class="form-control form-control-lg" @bind-Value="newPost.Title"
                                       placeholder="Enter a compelling headline..." />
                            <ValidationMessage For="@(() => newPost.Title)" />
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Topic *</label>
                                <InputSelect class="form-control" @bind-Value="newPost.Topic">
                                    <option value="">-- Select Topic --</option>
                                    <option value="News">Politics & News</option>
                                    <option value="Economy">Economy</option>
                                    <option value="Health">Health</option>
                                    <option value="Education">Education</option>
                                    <option value="Technology">Technology</option>
                                    <option value="Sport">Sport</option>
                                </InputSelect>
                                <ValidationMessage For="@(() => newPost.Topic)" />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Publication Status</label>
                                <div class="form-check">
                                    <InputCheckbox class="form-check-input" @bind-Value="newPost.IsPublished" id="isPublished" />
                                    <label class="form-check-label" for="isPublished">
                                        Publish immediately
                                    </label>
                                </div>
                                <div class="form-check">
                                    <InputCheckbox class="form-check-input" @bind-Value="newPost.IsFeatured" id="isFeatured" />
                                    <label class="form-check-label" for="isFeatured">
                                        Feature on homepage
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    @* Content Section *@
                    <div class="@(activeSection == "content" ? "" : "d-none")">
                        <div class="mb-3">
                            <label class="form-label">Article Content (Facts) *</label>
                            <InputTextArea class="form-control" rows="12" @bind-Value="newPost.Content"
                                           placeholder="Write the factual content of your article..." />
                            <ValidationMessage For="@(() => newPost.Content)" />
                            <small class="text-muted">@newPost.Content.Length characters</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Editorial Opinion (Optional)</label>
                            <InputTextArea class="form-control" rows="8" @bind-Value="newPost.Opinion"
                                           placeholder="Add your editorial perspective or analysis..." />
                            <small class="text-muted">This will appear in a separate opinion section</small>
                        </div>
                    </div>

                    @* Media Section *@
                    <div class="@(activeSection == "media" ? "" : "d-none")">
                        <div class="mb-3">
                            <label class="form-label">Featured Image URL</label>
                            <InputText class="form-control" @bind-Value="newPost.FeaturedImageUrl"
                                       placeholder="https://example.com/image.jpg" />
                            <small class="text-muted">Main article image (1200x600 recommended)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Thumbnail Image URL</label>
                            <InputText class="form-control" @bind-Value="newPost.ThumbnailImageUrl"
                                       placeholder="https://example.com/thumbnail.jpg" />
                            <small class="text-muted">Card/list image (400x300 recommended)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Image Caption</label>
                            <InputText class="form-control" @bind-Value="newPost.ImageCaption"
                                       placeholder="Describe the image..." />
                        </div>

                        @if (!string.IsNullOrEmpty(newPost.FeaturedImageUrl))
                        {
                            <div class="mb-3">
                                <label class="form-label">Preview:</label>
                                <img src="@newPost.FeaturedImageUrl" class="img-fluid rounded" alt="Preview"
                                     style="max-height: 300px;" />
                            </div>
                        }
                    </div>

                    @* Sources Section *@
                    <div class="@(activeSection == "sources" ? "" : "d-none")">
                        <div class="mb-3">
                            <label class="form-label">Sources & References</label>
                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="AddSource">
                                <i class="bi bi-plus-circle"></i> Add Source
                            </button>
                        </div>

                        @foreach (var source in sources)
                        {
                            <div class="card mb-2">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <input type="text" class="form-control form-control-sm"
                                                   placeholder="Source title" @bind="source.Title" />
                                        </div>
                                        <div class="col-md-5">
                                            <input type="url" class="form-control form-control-sm"
                                                   placeholder="https://..." @bind="source.Url" />
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-sm btn-danger"
                                                    @onclick="@(() => RemoveSource(source))">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <input type="text" class="form-control form-control-sm"
                                                   placeholder="Brief description (optional)" @bind="source.Description" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @* Navigation Buttons *@
                    <div class="d-flex justify-content-between mt-4">
                        <div>
                            @if (activeSection != "basic")
                            {
                                <button type="button" class="btn btn-secondary" @onclick="PreviousSection">
                                    <i class="bi bi-arrow-left"></i> Previous
                                </button>
                            }
                        </div>

                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" @onclick="SaveDraft"
                                    disabled="@isSaving">
                                @if (isSaving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <i class="bi bi-save"></i> Save as Draft
                            </button>

                            @if (activeSection == "sources")
                            {
                                <button type="submit" class="btn btn-primary" disabled="@isCreating">
                                    @if (isCreating)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="bi bi-send"></i> Publish Article
                                </button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-primary" @onclick="NextSection">
                                    Next <i class="bi bi-arrow-right"></i>
                                </button>
                            }
                        </div>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}